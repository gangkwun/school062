<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>단가표 다운로더</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 'Vibe' 스타일 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* 로딩 스피너 스타일 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #764ba2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8 transform transition-all hover:scale-105 duration-300">
        
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">단가표 다운로더</h1>
            <p class="text-gray-500 mt-2">'Vibe' 넘치게 검색하고 다운로드하세요.</p>
        </div>

        <!-- 입력 폼 -->
        <form id="downloadForm" class="space-y-6">
            <div>
                <label for="searchTerm" class="block text-sm font-medium text-gray-700 mb-1">검색어</label>
                <input type="text" id="searchTerm" name="searchTerm"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                       placeholder="예: SFC푸드맘 12월" required>
            </div>
            
            <!-- 버튼 및 로더 -->
            <div class="relative">
                <button type="submit" id="submitButton"
                        class="w-full flex items-center justify-center px-4 py-3 font-semibold text-white bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg shadow-lg hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-300 ease-in-out transform hover:-translate-y-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    다운로드 시작
                </button>
                
                <!-- 로딩 스피너 (숨겨져 있음) -->
                <div id="loadingIndicator" class="hidden absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 rounded-lg">
                    <div class="loader"></div>
                    <span class="ml-3 text-gray-700 font-medium">로그인 및 검색 중...</span>
                </div>
            </div>
        </form>
        
        <!-- 메시지 영역 -->
        <div id="messageArea" class="mt-6 text-center text-sm">
            <!-- 성공/실패 메시지가 여기에 표시됩니다. -->
        </div>

    </div>

    <script>
        const form = document.getElementById('downloadForm');
        const submitButton = document.getElementById('submitButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageArea = document.getElementById('messageArea');
        const searchTermInput = document.getElementById('searchTerm');

        // 서버 URL (app.py가 실행되는 주소)
        const SERVER_URL = 'http://127.0.0.1:5000/download';

        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // 폼 기본 제출 방지
            
            const searchTerm = searchTermInput.value;
            if (!searchTerm) {
                showMessage('검색어를 입력하세요.', 'error');
                return;
            }

            // 1. UI를 '로딩' 상태로 변경
            setLoading(true);

            try {
                // 2. Python 서버(app.py)에 '다운로드' 요청
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ search_term: searchTerm }),
                });

                // 3. 서버 응답 처리
                if (response.ok) {
                    // 3-1. 성공: 파일 다운로드
                    
                    // 헤더에서 파일 이름 가져오기
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `${searchTerm.replace(/ /g, '_')}.xls`; // 기본값
                    
                    if (contentDisposition) {
                        // "filename=" 뒤의 값을 디코딩
                        const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (filenameMatch && filenameMatch[1]) {
                             try {
                                // UTF-8로 인코딩된 파일 이름을 디코딩
                                filename = decodeURIComponent(escape(window.atob(filenameMatch[1])));
                             } catch (err) {
                                try {
                                    // 또는 URL 디코딩 시도
                                    filename = decodeURIComponent(filenameMatch[1]);
                                } catch (err2) {
                                    filename = filenameMatch[1]; // 실패 시 원본 사용
                                    console.warn('Filename decoding failed:', err, err2);
                                }
                             }
                        }
                    }

                    // 응답 본문을 Blob(파일 데이터)으로 변환
                    const blob = await response.blob();
                    
                    // 다운로드를 위한 임시 링크 생성
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename; // 서버에서 받은 파일 이름 설정
                    
                    document.body.appendChild(a);
                    a.click(); // 임시 링크 클릭 (다운로드 창 뜸)
                    
                    // 리소스 정리
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    
                    showMessage(`'${filename}' 다운로드 성공!`, 'success');

                } else {
                    // 3-2. 실패: 서버가 보낸 에러 메시지 표시
                    const errorData = await response.json();
                    let errorMessage = errorData.error || '알 수 없는 오류가 발생했습니다.';
                    
                    // 401: 로그인 실패
                    if(response.status === 401) {
                        errorMessage = `로그인 실패. app.py의 ID/PW를 확인하세요. (서버 메시지: ${errorMessage})`;
                    }
                    // 404: 검색 결과 없음
                    else if(response.status === 404) {
                         errorMessage = `검색 실패. (서버 메시지: ${errorMessage})`;
                    }
                    
                    showMessage(errorMessage, 'error');
                }

            } catch (error) {
                // 3-3. 네트워크 오류: 서버가 꺼져있거나 연결 불가
                console.error('Fetch error:', error);
                showMessage('서버에 연결할 수 없습니다. app.py가 실행 중인지 확인하세요.', 'error');
            } finally {
                // 4. UI를 다시 '기본' 상태로 변경
                setLoading(false);
            }
        });

        // 로딩 상태 UI 변경 함수
        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                messageArea.innerHTML = '';
            } else {
                submitButton.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            }
        }

        // 메시지 표시 함수
        function showMessage(message, type = 'info') {
            const color = type === 'error' ? 'text-red-600' : 'text-green-600';
            messageArea.innerHTML = `<p class="${color}">${message}</p>`;
        }

    </script>
</body>
</html>
